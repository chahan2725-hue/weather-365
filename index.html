if ("Notification" in window && Notification.permission === "default") {
  Notification.requestPermission();
}

let notifiedQuakeKeys = [];
let notifiedEEWKey = "";

// 補助関数
function depthToText(depth) { if(depth==null||depth<0)return "不明"; if(depth===0)return "ごく浅い"; return depth+"km"; }
function scaleToText(scale){ const map={10:'1',20:'2',30:'3',40:'4',45:'5-',50:'5+',55:'6-',60:'6+',70:'7'}; return map[scale]||'不明'; }
function scaleClass(scale){ return `scale-${scale.replace('+','plus').replace('-','minus')}`; }
function formatDate(t){ return new Date(t).toLocaleString("ja-JP",{timeZone:"Asia/Tokyo"}); }

// ---------------------
// コピー機能
// ---------------------
function copyToClipboard(text){ navigator.clipboard.writeText(text).then(()=>alert("コピーしました")); }

// ---------------------
// 地震情報取得
// ---------------------
async function fetchLatestEarthquakesWithNotify(){
  const url="https://api.p2pquake.net/v2/history?codes=551&limit=5";
  const container=document.getElementById("quakeList");
  container.innerHTML="読み込み中...";
  try{
    const res=await fetch(url);
    const data=await res.json();
    if(!data||data.length===0){ container.innerHTML="地震情報なし"; return; }
    container.innerHTML="";
    data.slice(0,5).forEach(item=>{
      const eq=item.earthquake;
      const h=eq.hypocenter;
      const place=h.name||"(発生地点不明)";
      const maxScale=scaleToText(eq.maxScale);
      const magnitude=(h.magnitude!=null&&h.magnitude>=0)?h.magnitude.toFixed(1):"不明";
      const depth=depthToText(h.depth);
      const timeStr=formatDate(eq.time);
      const tsunamiMsg = (eq.domesticTsunami==="Warning"||eq.domesticTsunami==="Watch") ? "津波に関する情報を発表しています。" : "この地震による津波の心配はありません。";

      // 各地震div作成
      const quakeDiv=document.createElement("div");
      quakeDiv.className=`quake ${scaleClass(maxScale)}`;
      let areaHTML="";
      if(item.points&&item.points.length>0){
        const cityMaxScale={};
        item.points.forEach(p=>{
          const scale=scaleToText(p.scale);
          const city=p.addr.match(/(.+?[市区町村])/)?p.addr.match(/(.+?[市区町村])/)[1]:p.addr;
          const key=`${p.pref}:${city}`;
          if(!cityMaxScale[key]||compareScale(scale,cityMaxScale[key])>0) cityMaxScale[key]=scale;
        });
        const grouped={};
        Object.keys(cityMaxScale).forEach(k=>{
          const [pref,city]=k.split(':');
          const scale=cityMaxScale[k];
          if(!grouped[scale]) grouped[scale]={};
          if(!grouped[scale][pref]) grouped[scale][pref]=[];
          grouped[scale][pref].push(city);
        });
        Object.keys(grouped).sort((a,b)=>compareScale(b,a)).forEach(scale=>{
          areaHTML+=`<div>◁震度${scale}▷</div>`;
          Object.keys(grouped[scale]).forEach(pref=>{
            areaHTML+=`<div>［${pref}］${grouped[scale][pref].sort().join("、")}</div>`;
          });
        });
      }

      quakeDiv.innerHTML=`<div class="quake-header">
        <div class="quake-icon"><i class="fa-solid fa-earthquake"></i></div>
        <div class="quake-main">
          <div>発生時刻: ${timeStr}</div>
          <div>震源地: ${place}</div>
          <div>最大震度: ${maxScale}</div>
          <div>M: ${magnitude}</div>
          <div>深さ: ${depth}</div>
          <div>${tsunamiMsg}</div>
          <button class="copyBtn">コピー</button>
        </div>
      </div>
      <details>
        <summary>各地の震度 ▼</summary>
        <div class="quake-area">${areaHTML}</div>
      </details>`;
      container.appendChild(quakeDiv);

      // コピー機能
      quakeDiv.querySelector(".copyBtn").addEventListener("click",()=>{ 
        let text=`《地震情報》\n${timeStr}\n震源地: ${place}\n最大震度: ${maxScale}\nM: ${magnitude}\n深さ: ${depth}\n${tsunamiMsg}\n各地の震度:\n${areaHTML.replace(/<[^>]+>/g,"")}`;
        copyToClipboard(text);
      });

      const key=`${item.id}_${item.issue?.type}`;
      if(!notifiedQuakeKeys.includes(key)&&Notification.permission==="granted"){
        new Notification("地震発生",{body:`${place} 最大震度:${maxScale} M${magnitude}`});
        notifiedQuakeKeys.push(key);
        if(notifiedQuakeKeys.length>5) notifiedQuakeKeys.shift();
      }
    });
  }catch(e){ container.innerHTML="地震情報取得エラー: "+e.message; }
}

// ---------------------
// EEW取得
// ---------------------
async function fetchLatestEEWWithNotify(){
  const url="https://api.wolfx.jp/jma_eew.json";
  const container=document.getElementById("eewList");
  container.innerHTML="読み込み中...";
  try{
    const res=await fetch(url);
    const data=await res.json();
    if(!data||Object.keys(data).length===0){ container.innerHTML="EEW情報なし"; return; }
    if(data.isTraining){ container.innerHTML="訓練報のため表示しません"; return; }
    if(data.isCancel){ container.innerHTML="このEEWはキャンセルされました"; return; }

    const isFinal=data.isFinal;
    const serialText=isFinal?"最終報":`第${data.Serial}報`;
    const originDate=data.OriginTime?new Date(data.OriginTime):null;
    const originStr=originDate?formatDate(originDate):"発生時刻不明";
    const hypocenter=data.Hypocenter??"震源地不明";
    const magnitude=data.Magunitude??"不明";
    const depth=data.Depth??"不明";
    const maxInt=data.MaxIntensity??"不明";

    let areaText="";
    if(data.WarnArea&&data.WarnArea.length>0){
      areaText=data.WarnArea.map(a=>a.Chiiki??a.chiiki).join("、");
      areaText=`対象地域: ${areaText}`;
    }

    const html=`<div class="quake ${scaleClass(maxInt)}">
      <div class="quake-header">
        <div class="quake-icon"><i class="fa-solid fa-bolt"></i></div>
        <div class="quake-main">
          <div>発生時刻: ${originStr} (${serialText})</div>
          <div>${hypocenter} で地震が発生した模様です。</div>
          <div>推定最大震度: ${maxInt}</div>
          <div>M: ${magnitude}</div>
          <div>深さ: ${depth} km</div>
          <div>${areaText}</div>
          <button class="copyBtn">コピー</button>
          <div>今後の情報に注意してください。</div>
        </div>
      </div>
    </div>`;
    container.innerHTML=html;

    container.querySelector(".copyBtn").addEventListener("click",()=>{
      let text=`◆緊急地震速報（${serialText}）◆\n発生時刻:${originStr}\n${hypocenter} で地震が発生した模様です。\n推定最大震度:${maxInt}\nM:${magnitude}\n深さ:${depth} km\n${areaText}\n今後の情報に注意してください。`;
      copyToClipboard(text);
    });

    const key=`${data.EventID}_${data.Serial}`;
    if(key!==notifiedEEWKey&&Notification.permission==="granted"){
      new Notification("緊急地震速報(EEW)",{body:`${hypocenter} 最大震度:${maxInt} M${magnitude}`});
      notifiedEEWKey=key;
    }

  }catch(e){ container.innerHTML="EEWデータ取得エラー: "+e.message; }
}

function compareScale(a,b){ const order={'1':10,'2':20,'3':30,'4':40,'5-':45,'5+':50,'6-':55,'6+':60,'7':70}; return (order[a]||0)-(order[b]||0); }

// 初回取得＆30秒自動更新
fetchLatestEarthquakesWithNotify();
fetchLatestEEWWithNotify();
setInterval(()=>{
  fetchLatestEarthquakesWithNotify();
  fetchLatestEEWWithNotify();
},30000);
